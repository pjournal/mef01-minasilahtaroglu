---
title: "Part I-II"
author: "Mina Silahtaroglu"
date: "15 Mayıs 2019"
output: html_document
---

## CONCLUSIONS FOR THIS VERSION:

* Turkish Pop Listeners Love The Mocking or Melancholic Songs The Best!!!
  Followed by despair, plaintive, love-sick songs :(
* The most positive vibed songs are from the artists: Serdar Ortac, Hande Yener
* For being the most listened/loved songs, there is no need to be danceable
* Top5 Artist in the lis according to the their occurence in the top50 songs Tarkan(6), followed by Sezen Aksu(5), Yalın(5), Teoman(5), Buray(5).
* There is no pattern to make a Turkish Pop hit song; danceability, energy (activeness, energeticness) and valence (musical positivity) are more common in the hits
* "Love"" is the most common word in the hit songs' name

# The libraries:

For this analysis, the libraries that will be used is documented below.

```{r message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

options(stringsAsFactors=FALSE)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(spotifyr)
library(ggjoy)
library(reshape)
library(treemap)
library(fmsb)
library(vcd)
library(wordcloud)
library(SnowballC)
library(RColorBrewer)
library(tm)
library(reshape2)

# load(file ="C:\\Users\\minas\\OneDrive\\Masaüstü\\Spot2.RData")
```


The Spotify Client ID and Client Secret (access token) should be reached by the use of Spotify for Developers page

```{r echo=FALSE, results='hide',message=FALSE}
Sys.setenv(SPOTIFY_CLIENT_ID = '300b3d7a176b4417b3e1e8f9898edec1')
Sys.setenv(SPOTIFY_CLIENT_SECRET = '74c6d7731865485c92ece1d6be3e5a54')

```

# Data Exploration

In this part, we are recieving data from Spotify API. The data that we are gathering is based on Turkish music genres. 
In this version, we are implementing our work on "Turkish Pop" genre.

We are showing our data in a data frame which includes attributes like:

artist_name / _id
album_name / _id
track_name / _id
track_popularity / artist_popularity
Track attributes(danceability, energy, instrumentalness, valence, energy, key, loudness, mode, tempo...)

Danceability will be used between 0-100 (0.0-1.0 in the actual): How likely to dance!
Energy will be used between 0-100 (0.0-1.0 in the actual): If the song is energetic, active or not
Speechiness: "Values above 66 describe tracks that are probably made entirely of spoken words."
Acousticness: From 0 to 100 decribes whether the track is acoustic
Liveness: "Higher liveness values represent an increased probability that the track was performed live"
Valence: 0-100, describes the musical positivity, cheerfulness etc.

```{r echo=FALSE, results='hide',message=FALSE}
# # The code below, with the use of API of Spotify, returns a dataframe that stores top tracks for an artist with the artist id

get_artist_top_tracks <- function(artist_id,essentials=TRUE){
  my_query <- paste0("https://api.spotify.com/v1/artists/",artist_id,"/top-tracks?country=TR&","access_token=",get_spotify_access_token())
  mydata <- jsonlite::fromJSON(my_query,flatten=TRUE)

  return_df <- mydata$tracks
  if(essentials){
    return_df <- return_df %>% select(track_id=id,track_name=name,track_popularity=popularity,album_id=album.id,album_name=album.name,duration_ms)
  }

  return(return_df)
}

# Returns a list that contains artist id, artist name, artist popularity, followers and genres

get_artists_info <- function(artist_ids,essentials=TRUE){
  artist_ids_p <- paste0(artist_ids,collapse=",")
  my_query <- paste0("https://api.spotify.com/v1/artists?ids=",artist_ids_p,"&access_token=",get_spotify_access_token())
  mydata <- jsonlite::fromJSON(my_query,flatten=TRUE)
  mydata <- mydata$artists

  artist_info <- mydata %>% select(artist_id=id,artist_name=name,artist_popularity=popularity,artist_followers=followers.total)
  # tibble(artist_id=mydata$id,artist_name=mydata$name,artist_popularity=mydata$popularity,artist_followers=mydata$followers$total)

  artist_genres <-
    mydata %>% select(artist_id=id,genres) %>% unnest(genres)

  return_list <- list(artist_info=artist_info,artist_genres=artist_genres)

  return(return_list)
}

track_ids<-c("3n3Ppam7vgaVa1iaRUc9Lp","3twNvmDtFQtAd5gMKedhLD")

# Returns all the attributes available for a track

get_track_audio_features <- function(track_ids,essentials=TRUE){
  track_ids_p <- paste0(track_ids,collapse=",")
  my_query <- paste0("https://api.spotify.com/v1/audio-features?ids=",track_ids_p,"&access_token=",get_spotify_access_token())
  mydata <- jsonlite::fromJSON(my_query,flatten=TRUE)

  return_df <- mydata$audio_features
  if(essentials){
    return_df <- return_df %>% select(track_id=id,danceability:tempo)
  }

  return(return_df)
}


# For the input genre returns a list of top 20 artists, with their top 10 songs

top20_by_genre <- function(genre_name="turkish pop"){

  genre_data <- get_genre_artists(genre_name)
  artist_ids <- genre_data$id
  artist_list <- get_artists_info(artist_ids)
  top_tracks <- tibble()
  for(i in 1:length(artist_ids)){
    temp_top_tracks <- get_artist_top_tracks(artist_ids[i])
    track_af <- get_track_audio_features(temp_top_tracks$track_id)
    temp_df <- left_join(temp_top_tracks,track_af,by="track_id") %>% mutate(artist_id=artist_ids[i]) %>% select(artist_id,everything())
    top_tracks <- bind_rows(top_tracks,temp_df)
  }

  return(list(artist_info=artist_list$artist_info,artist_genres=artist_list$artist_genres,top_tracks=top_tracks))
}

top20_info <- top20_by_genre(genre_name = "turkish pop")
print(top20_info)

glimpse(top20_info)

```


## From the top20_info list, a part of data is collected to make it easier to analyze:

The 0.0-1.0 valued track attributes are multiplied by 100 for being able to plot the artist song attributes in a radar chart.

```{r message=FALSE, warning=FALSE}
top20Artist_songFeatures <-
  top20_info$top_tracks %>% left_join(.,top20_info$artist_info,by="artist_id") %>%
  select(artist_name, album_name, track_name, everything()) %>%
  mutate_at(vars(danceability,energy,speechiness,acousticness,instrumentalness,liveness,valence),list(~.*100)) %>%
  tbl_df()

top20Artist_songFeatures

```


## We had fun :)

We looked for the most positive songs in the top20 artists' best songs. 
And it was "Karabiberim" from Serdar Ortac which is also our favorite!!!

```{r}
Musical_Positivity <-
  top20Artist_songFeatures %>%
  arrange(desc(valence)) %>% 
  select(artist_name,track_name, valence) %>% 
  head(10)

Musical_Positivity %>%
  knitr::kable()
```


# Joyplot for Musical Positivity (Valence)

The plot below represents the visualization of the artists in top20 accordingly with their songs' valence

```{r}
ggplot(top20Artist_songFeatures, aes(x = valence, y = artist_name)) + 
  geom_joy() + 
  theme_joy() +
  ggtitle("Joyplot of Top Artists' Musical Positivity", subtitle = "Based on valence / measurement of positivity")

```


# Analysis on 200 Top Tracks

## The Top200 Tracks data is arranged descending accordingly with the track popularity, top 10 is listed below:

The bar chart below represents the "Top10 Turkish Pop Songs" musical attributes

```{r}

# Top 10 Songs
Top10_songs <-
  top20Artist_songFeatures %>%
  arrange(desc(track_popularity)) %>%
  head(10)

knitr::kable(Top10_songs)

Top10_songs_v1 <- Top10_songs[, c(3,9,10,14,15,17,18)] 
Top10_songs_v1 <- as.data.frame(Top10_songs_v1)
Top10_songs_v1.long <- melt(Top10_songs_v1, id.vars="track_name")

ggplot(Top10_songs_v1.long, aes(x=variable, y=value))+geom_bar(aes(y=value, fill=track_name),stat="identity", alpha=0.8 , position="dodge")+ ylab("Value")+ xlab("Features")+coord_flip()+ggtitle("Top 10 Turkish Pop Songs in Spotify 2019")


```



# Artists' Frequency in the Top50:

(Since the dataset was a sample for top20 artists' best 10 songs, we had sliced the most popular 50 songs)

At this part, we have checked the frequencies of the artists in the top50 songs.
The most frequent artist in the list is Tarkan, followed by: Sezen Aksu, Yalın, Teoman, Buray. (Top5 Artists)


```{r}

Top50  <- 
  top20Artist_songFeatures %>%
  arrange(desc(track_popularity)) %>%
  slice(1:50)


Top50%>%count(artist_name,sort=TRUE)

```
# Radar chart for the Top5 singers in "Turkish Pop"
## Top Artist: Tarkan, followed by: Teoman, Yalın, Sezen Aksu and Buray :)

We have plotted a radar chart, accordingly with the song attributes which are valence, liveness, danceability, energy, speechiness, acousticness.

When we take a look at the radar charts, we have seen that:

Tarkan: For the best 6 songs of Tarkan, valence, energy and danceability is a big part. Speechiness, acousticness and liveness is relatively less common.
         The songs have similar vibes in the manner of attributes. 
Teoman: For the best 5 songs of Teoman, energy is high. All the songs variate in their attributes.
Yalin:  For the best 5 songs of Yalin, in general the difference between the songs come from "valence", behaves similar in the other attributes.
Buray:  For the best 5 songs of Buray, danceability, energy and speechiness is the most related attributes between his songs.Liveness and valence is a point of                  differentiation.
Sezen Aksu: For the best 5 songs of Sezen Aksu, they are all different from each other and has no spesific pattern.
```{r}
plotArtistRadar <- function(theArtist,songData){

# theArtist <- "Sezen Aksu"

prData <- 
  songData %>% 
  filter(artist_name==theArtist) %>%
  select(track_name,danceability, energy, speechiness, acousticness, liveness, valence)

# colors_border=c( rgb(0.2,0.5,0.5,0.9), rgb(0.8,0.2,0.5,0.9) , rgb(0.7,0.5,0.1,0.9))
# colors_in=c( rgb(0.2,0.5,0.5,0.4), rgb(0.8,0.2,0.5,0.4) , rgb(0.7,0.5,0.1,0.4))
radarchart( prData %>% select(-track_name), axistype=1 , 
            #custom polygon
            # pcol=colors_border , pfcol=colors_in ,
            plwd=4 , plty=1,
            #custom the grid
            cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,100,20), cglwd=0.5,
            #custom labels
            vlcex=1 , title=paste0(theArtist," Top Songs from the Top50"), maxmin = FALSE
)
legend(x=1.3, y=1.0, legend = prData$track_name, bty = "n", pch=10 ,palette(), text.col = "black", cex=0.6, pt.cex=1.5)
} 

plotArtistRadar(theArtist = "Sezen Aksu",Top50)
plotArtistRadar(theArtist = "Tarkan",Top50)
plotArtistRadar(theArtist = "maNga",Top50)
plotArtistRadar(theArtist = "Buray",Top50)
plotArtistRadar(theArtist = "Emrah Karaduman",Top50)

```

# Turkish Pop Listeners Love The Mocking or Melancholic Songs The Best!!!
Followed by despair, plaintive, love-sick songs :(

## Keys & Modes in Top50 Songs

Key Characteristics and Mood [Link](https://ledgernote.com/blog/interesting/musical-key-characteristics-emotions/)

C major :Innocently Happy
C minor :Innocently Sad, Love-Sick
C sharp minor : Despair, Wailing, Weeping
C sharp major: fullness, sonorousness, euphony
D major: Triumphant, Victorious War-Cries
D minor: Serious, Pious, Ruminating
D sharp minor: Deep Distress, Existential Angst
D sharp major: Cruel, Hard, Yet Full of Devotion
E major: Quarrelsome, Boisterous, Incomplete Pleasure
E minor: Effeminate, Amorous, Restless
F major: Complaisance and calm
E sharp minor: Obscure, Plaintive, Funereal
F sharp major : Conquering Difficulties, Sighs of Relief
F sharp minor: Gloomy, Passionate Resentment
G major: Serious, Magnificent, Fantasy
G minor: Discontent, Uneasiness
G sharp major : Death, Eternity, Judgement
G sharp minor : Grumbling, Moaning, Wailing
A major : Joyful, Pastoral, Declaration of Love
A minor : Tender, Plaintive, Pious
A sharp major: Joyful, Quaint, Cheerful
Bflat minor : Terrible, the Night, Mocking
B major: Harsh, Strong, Wild, Rage
B minor: Solitary, Melancholic, Patience


```{r}

Top50$tone <- ifelse(Top50$mode==0, "minor", "major")

Top50$scale <-

                      ifelse (Top50$key==0, "C",
                      ifelse(Top50$key==1, "C#",
                      ifelse(Top50$key==2, "D",
                      ifelse(Top50$key==3,"D#" ,
                      ifelse(Top50$key==4, "E",
                      ifelse(Top50$key==5, "E#",
                      ifelse(Top50$key==6,"F",
                      ifelse(Top50$key==7, "F#",
                      ifelse(Top50$key==8, "G",
                      ifelse(Top50$key==9,"G#",
                      ifelse(Top50$key==10,"A","A#"))))))))))) 


Top50$keys <- paste(Top50$scale, Top50$tone, sep= " ")


tone1 <- group_by(Top50, keys)
tone2 <- dplyr::summarise(tone1,  count=n())
tone2 <- arrange(tone2, desc(count))

# Tonality treemap
treemap(tone2, index="keys", vSize="count", type="index", 
        palette="Pastel1", title="Top 50 Songs Key characteristics", fontsize.title=12)

# major vs Minor
major <- group_by(Top50, tone)
major2 <-dplyr::summarise(major, count=n())

# Major treemap
treemap(major2, index="tone", vSize="count", type="index", 
        palette="Pastel2", title="Top 50 Songs Major vs Minor", fontsize.title=12)
```

# The Most Common Words in the Hits!

"Love" is the most common word in the hit songs' names. 
The first visual represents the 200 songs of the top20 artists.
Second visual represents the most popular 50 tracks of 15 artists. The only word in common is "sensiz"

```{r echo=FALSE, message=FALSE , warning=FALSE}

names <- top20Artist_songFeatures$track_name
# names1 <- Top50$track_name
set.seed(123)


#gsub kullanarak, wordcloudu temizle. 

wordcloud(names, max.words=20 ,random.order=FALSE,rot.per=0.35,colors=brewer.pal(5, "Dark2"), main="Title")
# wordcloud(names1, max.words=10 ,random.order=FALSE,rot.per=0.35,colors=brewer.pal(4, "Dark2"), main="Title")
```


```{r}
# require(reshape2) - melt için

collectionAll <- tibble()
turkish_genres <- c("turkish pop","turkish rock")

for (i in 1:length(turkish_genres)){
  collection <- top20_by_genre(turkish_genres[i])

  collection_songFeatures <-
  collection$top_tracks %>% left_join(.,top20_info$artist_info,by="artist_id") %>%
  select(artist_name, album_name, track_name, everything()) %>%
  mutate_at(vars(danceability,energy,speechiness,acousticness,instrumentalness,liveness,valence),list(~.*100)) %>%
  mutate(Genre=turkish_genres[i]) %>%
  tbl_df()

  collectionAll <-
    collectionAll %>%
    bind_rows(collectionAll, collection_songFeatures)

}
```

```{r}
row.has.na <- apply(collectionAll, 1, function(x){any(is.na(x))})
# sum(row.has.na)

collectionAll_filtered <- collectionAll[!row.has.na,]
collectionAll_filtered%>%count(artist_name,sort=TRUE)

collectionAll_filtered <- collectionAll_filtered %>% distinct(track_name, artist_name, Genre, .keep_all = TRUE)

top20Artist_songFeatures <-
  top20Artist_songFeatures %>%
  mutate(genre="Turkish Pop")

# save.image(file="shinydata.RData")
```


```{r}
# load(file="shinydata.Rdata")
```

